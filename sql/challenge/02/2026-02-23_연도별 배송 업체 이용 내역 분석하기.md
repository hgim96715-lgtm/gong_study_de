---
tags:
  - SQL_TEST
related:
  - "[[00_SQL_Challenge_DashBoard]]"
  - "[[SQL_CASE_WHEN]]"
  - "[[Union_vs_Join]]"
source: solvesql
difficulty:
  - Lv.2
status: ğŸŸ¨ íŒíŠ¸ì°¸ê³ 
---
##  í•´ê²° ì „ëµ (Code Before Think)

> ë‚´ë…„ë„ ë°°ì†¡ ì—…ì²´ ê³„ì•½ì„ ìœ„í•´ ì—°ë„ë³„ ë°°ì†¡ ì—…ì²´ ì´ìš© ê±´ìˆ˜ì˜ í†µê³„ë¥¼ ì§‘ê³„í•˜ë ¤ê³  í•©ë‹ˆë‹¤.
>  ì˜¨ë¼ì¸ ì‡¼í•‘ëª°ì˜ íŒë§¤ ë‚´ì—­ì—ì„œ ë°˜í’ˆì´ ë°œìƒí•  ê²½ìš°, ë°˜í’ˆ íšŒìˆ˜ë¥¼ ìœ„í•´ 'ì¼ë°˜ ë°°ì†¡(Standard)' ì„œë¹„ìŠ¤ê°€ ì¶”ê°€ë¡œ 1íšŒ ì´ìš©ë©ë‹ˆë‹¤. 
>  ë°ì´í„°ë² ì´ìŠ¤ì—ëŠ” ë°˜í’ˆëœ ê±°ë˜ì— ëŒ€í•œ ì¶”ê°€ ë°°ì†¡ ê¸°ë¡ì´ ì—†ê¸° ë•Œë¬¸ì— ê³ ê°ì´ ì„ íƒí•œ ì›ë˜ ë°°ì†¡ ì˜µì…˜ê³¼ ë³„ê°œë¡œ ë°˜í’ˆ ê±´ìˆ˜ë¥¼ ì¼ë°˜ ë°°ì†¡ ì´ìš© ì‹¤ì ì— í•©ì‚°í•˜ì—¬ ì§‘ê³„í•´ì•¼ í•©ë‹ˆë‹¤.
>  ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¡°íšŒí•´ ë°°ì†¡ ì—…ì²´ ì´ìš© ê±´ìˆ˜ë¥¼ ë°°ì†¡ ì˜µì…˜ ë³„ë¡œ ì§‘ê³„í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”. ì¿¼ë¦¬ ê²°ê³¼ëŠ” ì•„ë˜ ì»¬ëŸ¼ì´ ìˆì–´ì•¼ í•˜ê³ , ì—°ë„ ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ì´ ë˜ì–´ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
>  `year`: ì—°ë„ `standard`: ì¼ë°˜ ë°°ì†¡ ì´ìš© ê±´ìˆ˜ `express`: ë¹ ë¥¸ ë°°ì†¡ ì´ìš© ê±´ìˆ˜`overnight`: ìµì¼ ë°°ì†¡ ì´ìš© ê±´ìˆ˜

1. **íƒ€ê²Ÿ ë°ì´í„°:** (ì–´ë–¤ í…Œì´ë¸”ì—ì„œ ë¬´ì—‡ì„ ë½‘ì•„ì•¼ í•˜ëŠ”ê°€?)
   - `transactions` í…Œì´ë¸”
	   - `purchased_at` ìƒí’ˆêµ¬ë§¤ì‹œê°
	   - `is_online_order` ì˜¨ë¼ì¸ êµ¬ë§¤ì—¬ë¶€
	   - `shipping_method` ë°°ì†¡ë°©ë²•(Standard/Overnight/Express)
	   - `is_returned` ìƒí’ˆ ë°˜í’ˆ ì—¬ë¶€ 
1. **ì¡°ê±´ ë¶„ì„:**
   - 
3. **ì‚¬ìš©í•  ë¬¸ë²•:**
   - `EXTRACT`
   - CASE WHEN
---
## ì •ë‹µ ì¿¼ë¦¬ (Solution)

```sql
SELECT EXTRACT(year FROM purchased_at) as year,
COUNT(CASE WHEN shipping_method='Standard'THEN 1 END) +
COUNT(CASE WHEN is_returned='true' and is_online_order='true' THEN 1 END) as standard,
COUNT(CASE WHEN shipping_method='Express'THEN 1 END) as express,
COUNT(CASE WHEN shipping_method='Overnight'THEN 1 END) as Overnight
FROM transactions
GROUP BY EXTRACT(year FROM purchased_at)
ORDER BY year
```

---
##  ì˜¤ë‹µ ë…¸íŠ¸ & ë°°ìš´ ì  (Retrospective)

-  **ë‚´ê°€ ì‹¤ìˆ˜í•œ ë¶€ë¶„:**
	- ì²˜ìŒì— ì´ë ‡ê²Œ í•´ì„œ `Standard ë°°ì†¡ + ë°˜í’ˆ` ì¸ ê²½ìš°ì—ë„ **1ë²ˆë§Œ ì§‘ê³„ë˜ëŠ” ì˜¤ë¥˜**ê°€ ë°œìƒ
```sql
CASE 
  WHEN shipping_method = 'Standard' THEN 1
  WHEN is_returned = 'true' THEN 1
END
```

    
-  **ìƒˆë¡œ ì•Œê²Œ ëœ í•¨ìˆ˜/ê¿€íŒ:**
	- í•œ ì»¬ëŸ¼ì—ì„œ ì—¬ëŸ¬ ë²ˆ ì§‘ê³„í•´ì•¼ í•˜ëŠ” ê²½ìš°`COUNT(...) + COUNT(...)` ë˜ëŠ” `SUM(...) + SUM(...)`

---
## ë‹¤ë¥¸  í’€ì´ê°€ ìˆë‹¤ë©´?

```sql
WITH shipping_events AS (
    SELECT
        purchased_at,
        shipping_method AS method
    FROM transactions

    UNION ALL

    SELECT
        purchased_at,
        'Standard' AS method
    FROM transactions
    WHERE is_returned = 'true'
      AND is_online_order = 'true'
)
SELECT
    EXTRACT(YEAR FROM purchased_at) AS year,
    COUNT(CASE WHEN method = 'Standard' THEN 1 END) AS standard,
    COUNT(CASE WHEN method = 'Express' THEN 1 END) AS express,
    COUNT(CASE WHEN method = 'Overnight' THEN 1 END) AS overnight
FROM shipping_events
GROUP BY EXTRACT(YEAR FROM purchased_at)
ORDER BY year;
```

|ìƒí™©|ë” ì í•©í•œ í•¨ìˆ˜|
|---|---|
|í•œ rowì—ì„œ ì—¬ëŸ¬ ë²ˆ ë”í•´ì•¼ í•¨|`SUM`|
|í•œ row = í•œ ì´ë²¤íŠ¸|`COUNT`|