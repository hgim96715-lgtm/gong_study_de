---
tags:
  - SQL_TEST
related:
  - "[[00_SQL_Challenge_DashBoard]]"
  - "[[SQL_Understanding_NULL]]"
source: solvesql
difficulty:
  - Lv.2
status: ğŸŸ§ ë³µìŠµ
---
##  í•´ê²° ì „ëµ (Code Before Think)

> ë‹¹ì‹ ì€ A/B í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì‚¬ìš©ì IDê°€ 10ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë–¨ì–´ì§€ëŠ” ì‚¬ìš©ìë¥¼ A ë²„í‚·ìœ¼ë¡œ, ë‚˜ëˆ„ì–´ ë–¨ì–´ì§€ì§€ ì•ŠëŠ” ì‚¬ìš©ìë¥¼ B ë²„í‚·ìœ¼ë¡œ ë‚˜ëˆˆ í›„ A ë²„í‚·ì— í• ë‹¹ëœ ì‚¬ìš©ìì—ê²Œë§Œ ë³€ê²½ì„ ì£¼ì–´ ì§€í‘œë¥¼ ì¶”ì í•˜ëŠ” ì‹¤í—˜ì„ ê³„íší•˜ê³  ìˆìŠµë‹ˆë‹¤.
> ì»¤ë¨¸ìŠ¤ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë²„í‚·ì„ ë‚˜ëˆŒ ë•ŒëŠ” ì‚¬ì „ì— ë²„í‚·ì´ ê· ë“±í•˜ê²Œ ë‚˜ë‰˜ì–´ì ¸ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ì ˆì°¨ê°€ í•„ìš”í•©ë‹ˆë‹¤. íŠ¹ì • ë²„í‚·ì— í° ì† ê³ ê°ì´ ëª°ë ¤ ìˆëŠ” ê²½ìš° í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì™œê³¡ ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
> ì´ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ë²„í‚·ë³„ ì‚¬ìš©ì ìˆ˜, í‰ê·  ì£¼ë¬¸ ìˆ˜, í‰ê·  ì£¼ë¬¸ ê¸ˆì•¡ì„ í™•ì¸í•˜ë ¤ê³  í•©ë‹ˆë‹¤. ì•„ë˜ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ëŠ” ì¿¼ë¦¬ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
> `bucket`: ì‚¬ìš©ì ë²„í‚·  `user_count`: ë²„í‚·ì— í¬í•¨ëœ ì‚¬ìš©ì ìˆ˜ `avg_orders`: ë²„í‚·ì— í¬í•¨ëœ ì‚¬ìš©ìë“¤ì˜ í‰ê·  ì£¼ë¬¸ ìˆ˜ `avg_revenue`: ë²„í‚·ì— í¬í•¨ëœ ì‚¬ìš©ìë“¤ì˜ í‰ê·  ì£¼ë¬¸ ê¸ˆì•¡ ($)
> í‰ê·  ì§‘ê³„ì— ì‚¬ìš©ë˜ëŠ” ì£¼ë¬¸ì—ëŠ” ìµœì¢…ì ìœ¼ë¡œ ë°˜í’ˆëœ ì£¼ë¬¸ì€ ì œì™¸í•´ì•¼ í•˜ê³ , ëª¨ë“  í‰ê· ê°’ì€ ì†Œìˆ˜ì  ì•„ë˜ ì…‹ì§¸ ìë¦¬ì—ì„œ ë°˜ì˜¬ë¦¼ í•´ ë‘˜ì§¸ ìë¦¬ê¹Œì§€ í‘œí˜„ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

1. **íƒ€ê²Ÿ ë°ì´í„°:** (ì–´ë–¤ í…Œì´ë¸”ì—ì„œ ë¬´ì—‡ì„ ë½‘ì•„ì•¼ í•˜ëŠ”ê°€?)
   - `transactions` í…Œì´ë¸”
	   - `customer_id` ê³ ê° ID
	   - `total_price` ì£¼ë¬¸ê¸ˆì•¡
1. **ì¡°ê±´ ë¶„ì„:**
   - 
3. **ì‚¬ìš©í•  ë¬¸ë²•:**
   - 
---
## ì •ë‹µ ì¿¼ë¦¬ (Solution)

```sql
-- ì—¬ê¸°ì— ì‘ì„±í•œ ì¿¼ë¦¬ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
WITH user_metrics AS (
SELECT
(CASE WHEN customer_id % 10 = 0 THEN 'A' ELSE 'B' END) AS bucket,
customer_id,
COUNT(CASE WHEN is_returned = FALSE THEN transaction_id END) AS order_count,
COALESCE(SUM(CASE WHEN is_returned = FALSE THEN total_price END), 0) AS total_revenue
FROM transactions
GROUP BY bucket, customer_id
)

SELECT
bucket,
COUNT(customer_id) AS user_count,
ROUND(AVG(order_count), 2) AS avg_orders,
ROUND(AVG(total_revenue), 2) AS avg_revenue
FROM user_metrics
GROUP BY bucket;
```

---
##  ì˜¤ë‹µ ë…¸íŠ¸ & ë°°ìš´ ì  (Retrospective)

-  **ë‚´ê°€ ì‹¤ìˆ˜í•œ ë¶€ë¶„:**
	-##  í•´ê²° ì „ëµ (Code Before Think)

> ë‹¹ì‹ ì€ A/B í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì‚¬ìš©ì IDê°€ 10ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë–¨ì–´ì§€ëŠ” ì‚¬ìš©ìë¥¼ A ë²„í‚·ìœ¼ë¡œ, ë‚˜ëˆ„ì–´ ë–¨ì–´ì§€ì§€ ì•ŠëŠ” ì‚¬ìš©ìë¥¼ B ë²„í‚·ìœ¼ë¡œ ë‚˜ëˆˆ í›„ A ë²„í‚·ì— í• ë‹¹ëœ ì‚¬ìš©ìì—ê²Œë§Œ ë³€ê²½ì„ ì£¼ì–´ ì§€í‘œë¥¼ ì¶”ì í•˜ëŠ” ì‹¤í—˜ì„ ê³„íší•˜ê³  ìˆìŠµë‹ˆë‹¤.
> ì»¤ë¨¸ìŠ¤ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë²„í‚·ì„ ë‚˜ëˆŒ ë•ŒëŠ” ì‚¬ì „ì— ë²„í‚·ì´ ê· ë“±í•˜ê²Œ ë‚˜ë‰˜ì–´ì ¸ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ì ˆì°¨ê°€ í•„ìš”í•©ë‹ˆë‹¤. íŠ¹ì • ë²„í‚·ì— í° ì† ê³ ê°ì´ ëª°ë ¤ ìˆëŠ” ê²½ìš° í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì™œê³¡ ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
> ì´ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ë²„í‚·ë³„ ì‚¬ìš©ì ìˆ˜, í‰ê·  ì£¼ë¬¸ ìˆ˜, í‰ê·  ì£¼ë¬¸ ê¸ˆì•¡ì„ í™•ì¸í•˜ë ¤ê³  í•©ë‹ˆë‹¤. ì•„ë˜ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ëŠ” ì¿¼ë¦¬ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
> `bucket`: ì‚¬ìš©ì ë²„í‚·  `user_count`: ë²„í‚·ì— í¬í•¨ëœ ì‚¬ìš©ì ìˆ˜ `avg_orders`: ë²„í‚·ì— í¬í•¨ëœ ì‚¬ìš©ìë“¤ì˜ í‰ê·  ì£¼ë¬¸ ìˆ˜ `avg_revenue`: ë²„í‚·ì— í¬í•¨ëœ ì‚¬ìš©ìë“¤ì˜ í‰ê·  ì£¼ë¬¸ ê¸ˆì•¡ ($)
> í‰ê·  ì§‘ê³„ì— ì‚¬ìš©ë˜ëŠ” ì£¼ë¬¸ì—ëŠ” ìµœì¢…ì ìœ¼ë¡œ ë°˜í’ˆëœ ì£¼ë¬¸ì€ ì œì™¸í•´ì•¼ í•˜ê³ , ëª¨ë“  í‰ê· ê°’ì€ ì†Œìˆ˜ì  ì•„ë˜ ì…‹ì§¸ ìë¦¬ì—ì„œ ë°˜ì˜¬ë¦¼ í•´ ë‘˜ì§¸ ìë¦¬ê¹Œì§€ í‘œí˜„ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

1. **íƒ€ê²Ÿ ë°ì´í„°:** (ì–´ë–¤ í…Œì´ë¸”ì—ì„œ ë¬´ì—‡ì„ ë½‘ì•„ì•¼ í•˜ëŠ”ê°€?)
   - `transactions` í…Œì´ë¸”
	   - `customer_id` ê³ ê° ID
	   - `total_price` ì£¼ë¬¸ê¸ˆì•¡
1. **ì¡°ê±´ ë¶„ì„:**
   - 
3. **ì‚¬ìš©í•  ë¬¸ë²•:**
   - 
---
## ì •ë‹µ ì¿¼ë¦¬ (Solution)

```sql
-- ì—¬ê¸°ì— ì‘ì„±í•œ ì¿¼ë¦¬ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
WITH user_metrics AS (
SELECT
(CASE WHEN customer_id % 10 = 0 THEN 'A' ELSE 'B' END) AS bucket,
customer_id,
COUNT(CASE WHEN is_returned = FALSE THEN transaction_id END) AS order_count,
COALESCE(SUM(CASE WHEN is_returned = FALSE THEN total_price END), 0) AS total_revenue
FROM transactions
GROUP BY bucket, customer_id
)

SELECT
bucket,
COUNT(customer_id) AS user_count,
ROUND(AVG(order_count), 2) AS avg_orders,
ROUND(AVG(total_revenue), 2) AS avg_revenue
FROM user_metrics
GROUP BY bucket;
```

---
##  ì˜¤ë‹µ ë…¸íŠ¸ & ë°°ìš´ ì  (Retrospective)

-  **ë‚´ê°€ ì‹¤ìˆ˜í•œ ë¶€ë¶„:**
	- `COALESCE(SUM(CASE WHEN is_returned = FALSE THEN total_price END), 0) AS total_revenue` ì´ ë¶€ë¶„ì´ ê³„ì† ë§‰í˜”ì—ˆë‹¤. sumí•´ë„ ì˜ ë˜ì§€ ì•Šì•˜ë‹¤ ë°˜í’ˆë§Œ í•œ ìœ ì €(NULL)ëŠ” 0ìœ¼ë¡œ ì¹˜í™˜í•´ì•¼ í•¨ì„ ìŠì—ˆë‹¤.
-  **ìƒˆë¡œ ì•Œê²Œ ëœ í•¨ìˆ˜/ê¿€íŒ:**
	- **`AVG()` í•¨ìˆ˜ì™€ `NULL`ì˜ ê´€ê³„:** SQLì˜ `AVG` í•¨ìˆ˜ëŠ” `NULL` ê°’ì„ ë¶„ëª¨ì—ì„œ ì•„ì˜ˆ ë¹¼ë²„ë¦°ë‹¤. 0ì›ì„ ì“´ ìœ ì €ë„ 'ìœ ì € 1ëª…'ìœ¼ë¡œ í‰ê· ì— ë°˜ì˜í•˜ë ¤ë©´ ë°˜ë“œì‹œ `COALESCE(ê°’, 0)` ì²˜ë¦¬ê°€ í•„ìˆ˜ì ì´ë‹¤.


---
## ë” ë‚˜ì€ í’€ì´ê°€ ìˆë‹¤ë©´?

```sql
-- ë” ë‚˜ì€ í’€ì´ê°€ ìˆì„ê²½ìš° 
WITH user_metrics AS (
    SELECT 
        customer_id,
        COUNT(CASE WHEN is_returned = FALSE THEN transaction_id END) AS order_count,
        COALESCE(SUM(CASE WHEN is_returned = FALSE THEN total_price END), 0) AS total_revenue
    FROM transactions
    GROUP BY customer_id
)

SELECT 
    (CASE WHEN customer_id % 10 = 0 THEN 'A' ELSE 'B' END) AS bucket,
    COUNT(customer_id) AS user_count,
    ROUND(AVG(order_count), 2) AS avg_orders,
    ROUND(AVG(total_revenue), 2) AS avg_revenue
FROM user_metrics
GROUP BY bucket; 
```
