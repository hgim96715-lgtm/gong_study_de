---
tags:
  - SQL_TEST
related:
  - "[[SubQuery_CTE]]"
  - "[[Aggregation_GROUP_BY]]"
  - "[[Numeric_Functions]]"
source: solvesql
difficulty:
  - Lv.1
status:
  - 🟩 해결
---
##  해결 전략 (Code Before Think)

> 이 레스토랑의 일일 평균 매출을 계산해주세요. 
> 컬럼의 이름은 `avg_sales`로 출력해주세요. 
> 결과는 소수점 아래 셋째 자리에서 반올림하여 둘째 자리까지 표시되어야 합니다.

1. **타겟 데이터:** (어떤 테이블에서 무엇을 뽑아야 하는가?)
   - tips 테이블
   - day 요일 
   - total_bill 식사금액
1. **조건 분석:**
   - 일일 -> 요일별 
   - 요일별 매출(`SUM(total_bill)`)을 구한 뒤→ 그 값들의 평균을 계산해야 함 → `AVG`
   - 결과 2째자리까지 
1. **사용할 문법:**
   - Group By
   - AVG
   - ROUND

>요일별로 매출을 먼저 집계하고, 그 집계 결과의 평균을 구한다.
---
## 정답 쿼리 (Solution)

```sql
-- 여기에 작성한 쿼리를 붙여넣으세요.
WITH day_bill AS(
SELECT day,SUM(total_bill) as tb
FROM tips
GROUP BY day
)

SELECT round(AVG(tb),2) as avg_sales
FROM day_bill
```

---
##  오답 노트 & 배운 점 (Retrospective)

-  **내가 실수한 부분:**
	- 처음에는 `AVG(SUM(total_bill))` 처럼 **집계 함수 안에 집계 함수를 바로 쓰는 방식**을 시도하려고 했다.
	- SQL에서는 **집계 함수는 같은 SELECT 레벨에서 중첩해서 사용할 수 없다는 규칙**을 정확히 인지하지 못했다.
-  **새로 알게 된 함수/꿀팁:**
	- `AVG(SUM())` 이 필요해 보일 때는 **“아, 한 번 더 감싸야겠구나”** 하고 CTE/서브쿼리를 떠올리자.
	- `SUM(total_bill) / COUNT(DISTINCT day)` 처럼 수식으로 평균을 직접계산하는 방법도 있다.

---
## 더 나은 풀이가 있다면?

```sql
-- 더 나은 풀이가 있을경우 
SELECT ROUND(AVG(tb), 2) AS avg_sales
FROM (
  SELECT day, SUM(total_bill) AS tb
  FROM tips
  GROUP BY day
) t;
```
