---
aliases: []
tags:
  - SQL_TEST
related:
  - "[[Window_Functions]]"
  - "[[SubQuery_CTE]]"
source: solvesql
difficulty:
  - Lv.2
status: 🟥 실패
---

##  해결 전략 (Code Before Think)

> 2022년 중 이틀 연속 미세먼지 수치가 나빠져 30㎍/㎥ 이상이 된 날을 추출하는 쿼리를 작성해주세요.
> 날짜 기준 오름차순 정렬되어야 합니다. 
> 2022년 날짜별 미세먼지 중에서 전날보다 수치가 증가했고 이틀연속 30 이상인 날을 그 날자 기준 정렬
>  1월 3일의 미세먼지 수치가 28㎍/㎥ 이고, 1월 4일의 미세먼지 수치가 37㎍/㎥, 1월 5일의 미세먼지 수치가 52㎍/㎥ 이라면 1월 5일이 이틀 연속 미세먼지 수치가 나빠져 30㎍/㎥ 이상이 된 날 입니다.

1. **타겟 데이터:** (어떤 테이블에서 무엇을 뽑아야 하는가?)
   - measurements 테이블
   -  pm10 미세먼지 농도 
   - measured_at 측정일시 
1. **조건 분석:**
   - 이틀 연속 미세먼지수치 -> 두 날짜의 미세먼지 비교 , 전날값, 전전날값 까지 비교 하고 있음
   - 어제 데이터 는 `LAG(pm10,1)` , 이틀전데이터 `LAG(pm10,2)`
   - 오늘 수치 30이상
   - 이틀전 < 어제 < 오늘 순으로 커져야함
1. **사용할 문법:**
   - LAG()
   - CTE
   - WHERE
---
## 정답 쿼리 (Solution)

```sql
-- 여기에 작성한 쿼리를 붙여넣으세요.
WITH dust_history AS(
SELECT pm10, measured_at,
LAG(pm10,1) OVER(ORDER BY measured_at) as pm10_lag1,
LAG(pm10,2) OVER(ORDER BY measured_at) as pm10_lag2
FROM measurements
)


SELECT measured_at AS date_alert
FROM dust_history
WHERE measured_at>='2022-01-01' AND measured_at<'2023-01-01'
AND pm10>=30
AND pm10>pm10_lag1
AND pm10_lag1>pm10_lag2
ORDER BY date_alert;
```

---
##  오답 노트 & 배운 점 (Retrospective)

-  **내가 실수한 부분:**
	- `LAG()` 함수 안에 **날짜 컬럼(`measured_at`)을 넣으려고 했다** 
		`LAG(measured_at, 2) OVER (ORDER BY measured_at)`
		이 접근은 **“날짜를 비교”하려는 사고** 에서 나온 실수였다.
		`LAG()`는 **이전 행의 값(value)** 을 가져오는 함수이지  **이전 날짜를 계산하는 함수가 아니다**
		이 문제에서 비교 대상은 날짜가 아니라 미세 먼지 수치이다 

-  **새로 알게 된 함수/꿀팁:**
	- **날짜는 정렬용, 값은 비교용**
	- 연속 / 전날 / 이전이 보이면 윈도우 함수(LAG/LEAD)
---
## 더 나은 풀이가 있다면?

```sql
-- 더 나은 풀이가 있을경우 
```
